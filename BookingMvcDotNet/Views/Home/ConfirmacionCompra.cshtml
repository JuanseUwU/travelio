@using BookingMvcDotNet.Services
@{
    ViewData["Title"] = "Compra Confirmada";
    var reservas = ViewBag.Reservas as List<ReservaResult> ?? new List<ReservaResult>();
    var compraId = ViewBag.CompraId;
}

<section class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0 text-center">
                <div class="card-body p-5">
                    <!-- Icono de éxito animado -->
                    <div class="mb-4">
                        <div class="success-checkmark">
                            <div class="check-icon">
                                <span class="icon-line line-tip"></span>
                                <span class="icon-line line-long"></span>
                                <div class="icon-circle"></div>
                                <div class="icon-fix"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h1 class="fw-bold text-success mb-3">¡Compra Exitosa!</h1>
                    
                    <p class="lead text-muted mb-4">@ViewBag.Mensaje</p>

                    <div class="bg-light rounded p-4 mb-4">
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <h6 class="text-muted mb-1">Número de Compra</h6>
                                <h4 class="fw-bold text-primary">#@compraId</h4>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-1">Total Pagado</h6>
                                <h4 class="fw-bold text-success">@ViewBag.TotalPagado</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para factura de Travelio -->
                    <div class="mb-4">
                        <a asp-action="FacturaTravelio" asp-route-compraId="@compraId" 
                           class="btn btn-success btn-lg" target="_blank">
                            <i class="bi bi-receipt"></i> Descargar Factura Travelio
                        </a>
                    </div>

                    @if (reservas.Any())
                    {
                        <div class="text-start mb-4">
                            <h5 class="fw-bold mb-3"><i class="bi bi-list-check"></i> Tus Reservas</h5>
                            @foreach (var reserva in reservas)
                            {
                                var iconClass = reserva.Tipo switch {
                                    "CAR" => "bi-car-front text-primary",
                                    "HOTEL" => "bi-building text-success",
                                    "FLIGHT" => "bi-airplane text-warning",
                                    "RESTAURANT" => "bi-cup-straw text-danger",
                                    "PACKAGE" => "bi-backpack2 text-info",
                                    _ => "bi-ticket-perforated text-secondary"
                                };
                                
                                <div class="card mb-3 @(reserva.Exitoso ? "border-success" : "border-danger")">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="bi @iconClass"></i> @reserva.Titulo
                                                </h6>
                                                @if (reserva.Exitoso)
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> Confirmada #@reserva.CodigoReserva
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> @reserva.Error</span>
                                                }
                                            </div>
                                            <div class="d-flex gap-2">
                                                @if (reserva.Exitoso && !string.IsNullOrEmpty(reserva.FacturaProveedorUrl))
                                                {
                                                    <a href="@reserva.FacturaProveedorUrl" target="_blank" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-file-pdf"></i> Factura Proveedor
                                                    </a>
                                                }
                                                else if (reserva.Exitoso)
                                                {
                                                    <span class="btn btn-sm btn-outline-secondary disabled" 
                                                          title="La factura del proveedor no está disponible">
                                                        <i class="bi bi-file-pdf"></i> Factura en proceso...
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <div class="alert alert-info text-start">
                        <h6 class="fw-bold mb-2"><i class="bi bi-envelope"></i> Revisa tu correo</h6>
                        <p class="mb-0 small">
                            Hemos enviado la confirmación de tu compra y las facturas a tu correo electrónico registrado.
                        </p>
                    </div>

                    <div class="d-flex gap-3 justify-content-center mt-4">
                        <a asp-controller="Home" asp-action="Profile" class="btn btn-primary btn-lg">
                            <i class="bi bi-person-circle"></i> Ver Mi Perfil
                        </a>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-house"></i> Volver al Inicio
                        </a>
                    </div>
                </div>
            </div>

            <!-- Información adicional con iconos bonitos -->
            <div class="row mt-4 g-3">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle-sm bg-primary bg-opacity-10 text-primary mx-auto mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                </svg>
                            </div>
                            <h6 class="fw-bold">Confirmación por Email</h6>
                            <p class="small text-muted mb-0">Recibirás los detalles en tu correo.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle-sm bg-success bg-opacity-10 text-success mx-auto mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                                    <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029z"/>
                                </svg>
                            </div>
                            <h6 class="fw-bold">Facturas Digitales</h6>
                            <p class="small text-muted mb-0">Descarga arriba tus facturas.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle-sm bg-warning bg-opacity-10 text-warning mx-auto mb-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
                                </svg>
                            </div>
                            <h6 class="fw-bold">Soporte 24/7</h6>
                            <p class="small text-muted mb-0">Estamos para ayudarte.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Checkmark animado */
    .success-checkmark {
        width: 80px;
        height: 80px;
        margin: 0 auto;
    }
    .check-icon {
        width: 80px;
        height: 80px;
        position: relative;
        border-radius: 50%;
        box-sizing: content-box;
        border: 4px solid #4CAF50;
    }
    .check-icon::before {
        top: 3px;
        left: -2px;
        width: 30px;
        transform-origin: 100% 50%;
        border-radius: 100px 0 0 100px;
    }
    .check-icon::after {
        top: 0;
        left: 30px;
        width: 60px;
        transform-origin: 0 50%;
        border-radius: 0 100px 100px 0;
        animation: rotate-circle 4.25s ease-in;
    }
    .check-icon::before, .check-icon::after {
        content: '';
        height: 100px;
        position: absolute;
        background: #FFFFFF;
        transform: rotate(-45deg);
    }
    .icon-line {
        height: 5px;
        background-color: #4CAF50;
        display: block;
        border-radius: 2px;
        position: absolute;
        z-index: 10;
    }
    .icon-line.line-tip {
        top: 46px;
        left: 14px;
        width: 25px;
        transform: rotate(45deg);
        animation: icon-line-tip 0.75s;
    }
    .icon-line.line-long {
        top: 38px;
        right: 8px;
        width: 47px;
        transform: rotate(-45deg);
        animation: icon-line-long 0.75s;
    }
    .icon-circle {
        top: -4px;
        left: -4px;
        z-index: 10;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        position: absolute;
        box-sizing: content-box;
        border: 4px solid rgba(76, 175, 80, .5);
    }
    .icon-fix {
        top: 8px;
        width: 5px;
        left: 26px;
        z-index: 1;
        height: 85px;
        position: absolute;
        transform: rotate(-45deg);
        background-color: #FFFFFF;
    }
    @@keyframes icon-line-tip {
        0% { width: 0; left: 1px; top: 19px; }
        54% { width: 0; left: 1px; top: 19px; }
        70% { width: 50px; left: -8px; top: 37px; }
        84% { width: 17px; left: 21px; top: 48px; }
        100% { width: 25px; left: 14px; top: 46px; }
    }
    @@keyframes icon-line-long {
        0% { width: 0; right: 46px; top: 54px; }
        65% { width: 0; right: 46px; top: 54px; }
        84% { width: 55px; right: 0px; top: 35px; }
        100% { width: 47px; right: 8px; top: 38px; }
    }
    .icon-circle-sm {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
